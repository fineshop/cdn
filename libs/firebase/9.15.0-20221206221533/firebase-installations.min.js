import{registerVersion as t,_getProvider as e,getApp as n,_registerComponent as r}from"./firebase-app.js";class a extends Error{constructor(t,e,n){super(e),this.code=t,this.customData=n,this.name="FirebaseError",Object.setPrototypeOf(this,a.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,i.prototype.create)}}class i{constructor(t,e,n){this.service=t,this.serviceName=e,this.errors=n}create(t,...e){var r,e=e[0]||{},n=this.service+"/"+t,t=this.errors[t],t=t?(r=e,t.replace(o,(t,e)=>{var n=r[e];return null!=n?String(n):`<${e}?>`})):"Error",t=this.serviceName+`: ${t} (${n}).`;return new a(n,t,e)}}const o=/\{\$([^}]+)}/g;class s{constructor(t,e,n){this.name=t,this.instanceFactory=e,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(t){return this.instantiationMode=t,this}setMultipleInstances(t){return this.multipleInstances=t,this}setServiceProps(t){return this.serviceProps=t,this}setInstanceCreatedCallback(t){return this.onInstanceCreated=t,this}}let c,u;const f=new WeakMap,p=new WeakMap,d=new WeakMap,l=new WeakMap,g=new WeakMap;let h={get(t,e,n){if(t instanceof IDBTransaction){if("done"===e)return p.get(t);if("objectStoreNames"===e)return t.objectStoreNames||d.get(t);if("store"===e)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return y(t[e])},set:(t,e,n)=>(t[e]=n,!0),has:(t,e)=>t instanceof IDBTransaction&&("done"===e||"store"===e)||e in t};function w(n){return n!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(u=u||[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey]).includes(n)?function(...t){return n.apply(v(this),t),y(f.get(this))}:function(...t){return y(n.apply(v(this),t))}:function(t,...e){e=n.call(v(this),t,...e);return d.set(e,t.sort?t.sort():[t]),y(e)}}function m(t){return"function"==typeof t?w(t):(t instanceof IDBTransaction&&(i=t,p.has(i)||(e=new Promise((t,e)=>{const n=()=>{i.removeEventListener("complete",a),i.removeEventListener("error",r),i.removeEventListener("abort",r)},a=()=>{t(),n()},r=()=>{e(i.error||new DOMException("AbortError","AbortError")),n()};i.addEventListener("complete",a),i.addEventListener("error",r),i.addEventListener("abort",r)}),p.set(i,e))),n=t,(c=c||[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]).some(t=>n instanceof t)?new Proxy(t,h):t);var i,e,n}function y(t){if(t instanceof IDBRequest){var i=t;const n=new Promise((t,e)=>{const n=()=>{i.removeEventListener("success",a),i.removeEventListener("error",r)},a=()=>{t(y(i.result)),n()},r=()=>{e(i.error),n()};i.addEventListener("success",a),i.addEventListener("error",r)});return n.then(t=>{t instanceof IDBCursor&&f.set(t,i)}).catch(()=>{}),g.set(n,i),n}if(l.has(t))return l.get(t);var e=m(t);return e!==t&&(l.set(t,e),g.set(e,t)),e}const v=t=>g.get(t),I=["get","getKey","getAll","getAllKeys","count"],b=["put","add","delete","clear"],S=new Map;function C(t,e){if(t instanceof IDBDatabase&&!(e in t)&&"string"==typeof e){if(S.get(e))return S.get(e);const a=e.replace(/FromIndex$/,""),r=e!==a,i=b.includes(a);return a in(r?IDBIndex:IDBObjectStore).prototype&&(i||I.includes(a))?(t=async function(t,...e){t=this.transaction(t,i?"readwrite":"readonly");let n=t.store;return r&&(n=n.index(e.shift())),(await Promise.all([n[a](...e),i&&t.done]))[0]},S.set(e,t),t):void 0}}h=(a=>({...a,get:(t,e,n)=>C(t,e)||a.get(t,e,n),has:(t,e)=>!!C(t,e)||a.has(t,e)}))(h);const k="@firebase/installations",T="0.6.0-20221206221533",D="w:"+T,E=new i("installations","Installations",{"missing-app-config-values":'Missing App configuration value: "{$valueName}"',"not-registered":"Firebase Installation is not registered.","installation-not-found":"Firebase Installation not found.","request-failed":'{$requestName} request failed with error "{$serverCode} {$serverStatus}: {$serverMessage}"',"app-offline":"Could not process request. Application offline.","delete-pending-registration":"Can't delete installation while there is a pending registration request."});function j(t){return t instanceof a&&t.code.includes("request-failed")}function P({projectId:t}){return`https://firebaseinstallations.googleapis.com/v1/projects/${t}/installations`}function $(t){return{token:t.token,requestStatus:2,expiresIn:(t=t.expiresIn,Number(t.replace("s","000"))),creationTime:Date.now()}}async function B(t,e){e=(await e.json()).error;return E.create("request-failed",{requestName:t,serverCode:e.code,serverMessage:e.message,serverStatus:e.status})}function q({apiKey:t}){return new Headers({"Content-Type":"application/json",Accept:"application/json","x-goog-api-key":t})}function L(t,{refreshToken:e}){const n=q(t);return n.append("Authorization","FIS_v2 "+e),n}async function O(t){var e=await t();return 500<=e.status&&e.status<600?t():e}function N(e){return new Promise(t=>{setTimeout(t,e)})}const M=/^[cdef][\w-]{21}$/;function x(){try{const n=new Uint8Array(17);(self.crypto||self.msCrypto).getRandomValues(n),n[0]=112+n[0]%16;e=n;var t=btoa(String.fromCharCode(...e)).replace(/\+/g,"-").replace(/\//g,"_").substr(0,22);return M.test(t)?t:""}catch(t){return""}var e}function A(t){return t.appName+"!"+t.appId}const F=new Map;function K(t,e){t=A(t);V(t,e);{const n=W();return n&&n.postMessage({key:t,fid:e}),void _()}}function V(t,e){var n=F.get(t);if(n)for(const t of n)t(e)}let H=null;function W(){return!H&&"BroadcastChannel"in self&&((H=new BroadcastChannel("[Firebase] FID Change")).onmessage=t=>{V(t.data.key,t.data.fid)}),H}function _(){0===F.size&&H&&(H.close(),H=null)}const z="firebase-installations-store";let R=null;function J(){return R=R||function({blocked:t,upgrade:e,blocking:n,terminated:a}){const r=indexedDB.open("firebase-installations-database",1),i=y(r);return e&&r.addEventListener("upgradeneeded",t=>{e(y(r.result),t.oldVersion,t.newVersion,y(r.transaction))}),t&&r.addEventListener("blocked",()=>t()),i.then(t=>{a&&t.addEventListener("close",()=>a()),n&&t.addEventListener("versionchange",()=>n())}).catch(()=>{}),i}({upgrade:(t,e)=>{0===e&&t.createObjectStore(z)}})}async function U(t,e){const n=A(t),a=(await J()).transaction(z,"readwrite"),r=a.objectStore(z),i=await r.get(n);return await r.put(e,n),await a.done,i&&i.fid===e.fid||K(t,e.fid),e}async function G(t){const e=A(t),n=(await J()).transaction(z,"readwrite");await n.objectStore(z).delete(e),await n.done}async function Y(t,e){const n=A(t),a=(await J()).transaction(z,"readwrite"),r=a.objectStore(z),i=await r.get(n),o=e(i);return void 0===o?await r.delete(n):await r.put(o,n),await a.done,!o||i&&i.fid===o.fid||K(t,o.fid),o}async function Z(e){let n;var t=await Y(e.appConfig,t=>{t=tt(t||{fid:x(),registrationStatus:0}),t=function(t,e){if(0!==e.registrationStatus)return 1===e.registrationStatus?{installationEntry:e,registrationPromise:Q(t)}:{installationEntry:e};if(!navigator.onLine)return{installationEntry:e,registrationPromise:Promise.reject(E.create("app-offline"))};e={fid:e.fid,registrationStatus:1,registrationTime:Date.now()};return{installationEntry:e,registrationPromise:async function(e,n){try{var t=await async function({appConfig:t,heartbeatServiceProvider:e},{fid:n}){const a=P(t),r=q(t),i=e.getImmediate({optional:!0});if(i){const t=await i.getHeartbeatsHeader();t&&r.append("x-firebase-client",t)}const o={fid:n,authVersion:"FIS_v2",appId:t.appId,sdkVersion:D},s={method:"POST",headers:r,body:JSON.stringify(o)},c=await O(()=>fetch(a,s));if(c.ok){const t=await c.json();return{fid:t.fid||n,registrationStatus:2,refreshToken:t.refreshToken,authToken:$(t.authToken)}}throw await B("Create Installation",c)}(e,n);return U(e.appConfig,t)}catch(t){throw j(t)&&409===t.customData.serverCode?await G(e.appConfig):await U(e.appConfig,{fid:n.fid,registrationStatus:0}),t}}(t,e)}}(e,t);return n=t.registrationPromise,t.installationEntry});return""===t.fid?{installationEntry:await n}:{installationEntry:t,registrationPromise:n}}async function Q(t){let e=await X(t.appConfig);for(;1===e.registrationStatus;)await N(100),e=await X(t.appConfig);if(0!==e.registrationStatus)return e;{const{installationEntry:e,registrationPromise:n}=await Z(t);return n||e}}function X(t){return Y(t,t=>{if(t)return tt(t);throw E.create("installation-not-found")})}function tt(t){return 1===t.registrationStatus&&t.registrationTime+1e4<Date.now()?{fid:t.fid,registrationStatus:0}:t}async function et({appConfig:t,heartbeatServiceProvider:e},n){[o,s]=[t,n["fid"]];const a=P(o)+`/${s}/authTokens:generate`,r=L(t,n),i=e.getImmediate({optional:!0});var o,s;if(i){const t=await i.getHeartbeatsHeader();t&&r.append("x-firebase-client",t)}const c={installation:{sdkVersion:D,appId:t.appId}},u={method:"POST",headers:r,body:JSON.stringify(c)},p=await O(()=>fetch(a,u));if(p.ok)return $(await p.json());throw await B("Generate Auth Token",p)}async function nt(r,i=!1){let o;var t=await Y(r.appConfig,t=>{if(!at(t))throw E.create("not-registered");var e,n,a=t.authToken;if(!(i||2!==a.requestStatus||(e=a,(n=Date.now())<e.creationTime||e.creationTime+e.expiresIn<n+36e5)))return t;if(1===a.requestStatus)return o=async function(t,e){let n=await rt(t.appConfig);for(;1===n.authToken.requestStatus;)await N(100),n=await rt(t.appConfig);var a=n.authToken;return 0===a.requestStatus?nt(t,e):a}(r,i),t;{if(!navigator.onLine)throw E.create("app-offline");e=t,n={requestStatus:1,requestTime:Date.now()};const i=Object.assign(Object.assign({},e),{authToken:n});return o=async function(e,n){try{var t=await et(e,n),a=Object.assign(Object.assign({},n),{authToken:t});return await U(e.appConfig,a),t}catch(t){throw!j(t)||401!==t.customData.serverCode&&404!==t.customData.serverCode?(a=Object.assign(Object.assign({},n),{authToken:{requestStatus:0}}),await U(e.appConfig,a)):await G(e.appConfig),t}}(r,i),i}});return o?await o:t.authToken}function rt(t){return Y(t,t=>{if(!at(t))throw E.create("not-registered");var e=t.authToken;return 1===e.requestStatus&&e.requestTime+1e4<Date.now()?Object.assign(Object.assign({},t),{authToken:{requestStatus:0}}):t})}function at(t){return void 0!==t&&2===t.registrationStatus}async function it(t){const e=t,{installationEntry:n,registrationPromise:a}=await Z(e);return(a||nt(e)).catch(console.error),n.fid}async function ot(t,e=!1){var n;return await(!(n=(await Z(t)).registrationPromise)||!await n),(await nt(t,e)).token}async function st(t,e){[i,o]=[t,e["fid"]];const n=P(i)+"/"+o,a={method:"DELETE",headers:L(t,e)},r=await O(()=>fetch(n,a));var i,o;if(!r.ok)throw await B("Delete Installation",r)}async function ct(t){var t=t["appConfig"],e=await Y(t,t=>{if(!t||0!==t.registrationStatus)return t});if(e){if(1===e.registrationStatus)throw E.create("delete-pending-registration");if(2===e.registrationStatus){if(!navigator.onLine)throw E.create("app-offline");await st(t,e),await G(t)}}}function ut(e,r){const i=e["appConfig"];{e=i;var n=r;W(),e=A(e);let t=F.get(e);t||(t=new Set,F.set(e,t)),t.add(n)}return()=>{{var t=i,e=r;const n=A(t),a=F.get(n);return void(a&&(a.delete(e),0===a.size&&F.delete(n),_()))}}}function ft(t=n()){return e(t,"installations").getImmediate()}function pt(t){return E.create("missing-app-config-values",{valueName:t})}const dt=t=>{const n=t.getProvider("app").getImmediate(),a=e(n,"installations").getImmediate();return{getId:()=>it(a),getToken:t=>ot(a,t)}};r(new s("installations",t=>{t=t.getProvider("app").getImmediate();return{app:t,appConfig:function(t){if(!t||!t.options)throw pt("App Configuration");if(!t.name)throw pt("App Name");for(const e of["projectId","apiKey","appId"])if(!t.options[e])throw pt(e);return{appName:t.name,projectId:t.options.projectId,apiKey:t.options.apiKey,appId:t.options.appId}}(t),heartbeatServiceProvider:e(t,"heartbeat"),_delete:()=>Promise.resolve()}},"PUBLIC")),r(new s("installations-internal",dt,"PRIVATE")),t(k,T),t(k,T,"esm2017");export{ct as deleteInstallations,it as getId,ft as getInstallations,ot as getToken,ut as onIdChange};